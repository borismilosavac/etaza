# Zgrada Plus — Modul **Obavještenja** (*Notifications*) — FRONTEND instrukcije (Flutter) — GitHub MD v1.0

> [!IMPORTANT]
> Dokument je striktno fokusiran na **frontend implementaciju** (*frontend implementation*) modula **Obavještenja** za role **Stanar** (*Resident*) i **Upravnik** (*Manager*), uključujući sve ekrane, funkcije, stanja, validacije, UX interakcije, offline ponašanje, pristupačnost (WCAG 2.1 AA) i razdvajanje **Freemium** (*Free*) i **Premium** (*Plus*) mogućnosti.

---

## Sadržaj

* [0. Ciljevi i definicije](#0-ciljevi-i-definicije)
* [1. Opseg funkcionalnosti (matrica po ulozi)](#1-opseg-funkcionalnosti-matrica-po-ulozi)
* [2. Navigacija i rute](#2-navigacija-i-rute)
* [3. Informaciona arhitektura (IA)](#3-informaciona-arhitektura-ia)
* [4. Model podataka (frontend view-model)](#4-model-podataka-frontend-view-model)
* [5. Feature flags: Freemium/Premium](#5-feature-flags-freemiumpremium)
* [6. Globalni UI standardi (tokeni, tipografija, layout)](#6-globalni-ui-standardi-tokeni-tipografija-layout)
* [7. Zajedničke komponente (UI kit)](#7-zajedničke-komponente-ui-kit)
* [8. Ekrani — Stanar (mobilni + web)](#8-ekrani--stanar-mobilni--web)
* [9. Ekrani — Upravnik (web + mobilni)](#9-ekrani--upravnik-web--mobilni)
* [10. Tokovi korisnika (state machine)](#10-tokovi-korisnika-state-machine)
* [11. Filteri, pretraga i sortiranje](#11-filteri-pretraga-i-sortiranje)
* [12. Thread poruke: stanar ↔ upravnik](#12-thread-poruke-stanar-↔-upravnik)
* [13. Bulk akcije (upravnik)](#13-bulk-akcije-upravnik)
* [14. Notifikacije (push/email/in-app)](#14-notifikacije-pushemailin-app)
* [15. Offline, keš, sinhronizacija](#15-offline-keš-sinhronizacija)
* [16. Greške, izuzeci i edge cases](#16-greške-izuzeci-i-edge-cases)
* [17. Pristupačnost (WCAG 2.1 AA) — checklista](#17-pristupačnost-wcag-21-aa--checklista)
* [18. Analitika događaja (event schema)](#18-analitika-događaja-event-schema)
* [19. QA/Acceptance kriterijumi (po ekranu)](#19-qaacceptance-kriterijumi-po-ekranu)
* [20. Implementacioni koraci (Sprint-ready)](#20-implementacioni-koraci-sprint-ready)

---

## 0. Ciljevi i definicije

### 0.1 Ciljevi modula

* Pouzdan **feed obavještenja** (*notifications feed*) sa filtrima, pretragom i stabilnim sortiranjem.
* Jasni **detalji obavještenja** (*notice detail*) sa prilozima, statusima i akcijama.
* Dvosmjerna komunikacija kroz **thread poruke** (*threaded replies*) u okviru obavještenja.
* Upravnik: pun **wizard za kreiranje** (*create wizard*), ciljanje, zakazivanje, objava, arhiva.
* Minimalna ovisnost o PII: telefon/email su **opcionalni**, in-app radi bez njih.

### 0.2 Kanonski pojmovi

* **Obavještenje** (*Notice*): sadržaj koji kreira upravnik.
* **Thread** (*Thread*): skup poruka vezanih za obavještenje.
* **Ciljanje** (*Targeting*): ko vidi obavještenje (zgrada, ulaz, sprat, grupa, pojedinac).
* **Potvrda prijema** (*Acknowledgement*): stanar potvrđuje da je pročitao/primio.
* **Freemium** (*Free*): osnovne funkcije za normalan rad zgrade.
* **Premium** (*Plus*): napredne funkcije (automatizacije, napredna analitika, SMS/failover, napredna segmentacija i rekurencija).

---

## 1. Opseg funkcionalnosti (matrica po ulozi)

### 1.1 Stanar — funkcije

* Pregled liste (feed), filteri, pretraga, otvaranje detalja.
* Označavanje pročitano (automatski na view) + ručno.
* **Odgovori upravniku** (*Reply to manager*) u threadu.
* Upload priloga u poruci (ograničeno) — samo u okviru thread-a.
* Potvrda prijema ako je aktivirana.
* Push/email opt-in (ako postoje podaci), in-app uvijek.

### 1.2 Upravnik — funkcije

* Lista obavještenja (draft/scheduled/published/archived/retracted).
* Wizard kreiranja (4 koraka) + preview.
* Ciljanje (zgrada/segment/grupa/pojedinci), status i kanali.
* Zakazivanje, objava, edit, arhiva, povlačenje.
* Pregled i obrada poruka od više stanara (thread view + grupisanje).
* Bulk akcije nad obavještenjima (ne nad porukama).

---

## 2. Navigacija i rute

> [!NOTE]
> Flutter implementacija treba podržati **mobilni** i **web** layout. Predlog koristi **go_router** (*router*) sa deep link podrškom.

### 2.1 Rute (kanonske)

* `/notices` — lista obavještenja (role-aware)
* `/notices/:id` — detalj obavještenja
* `/notices/:id/thread` — fokus na thread (opciono, može biti tab unutar detail)

Upravnik:

* `/notices/new` — wizard (korak 1)
* `/notices/new?step=2` — meta/ciljanje
* `/notices/new?step=3` — dodatno
* `/notices/new?step=4` — pregled i objava

Opcionalno (web):

* `/notices/:id/edit` — edit (re-use wizard)

### 2.2 Deep links

* `zgradaplus://notices/:id`
* `zgradaplus://notices/:id?focus=thread&messageId=...`

---

## 3. Informaciona arhitektura (IA)

```
Obavještenja
 ├─ Lista
 │   ├─ Search
 │   ├─ Filter overlay/drawer
 │   ├─ Sort indicator
 │   └─ (Upravnik) Bulk selection bar
 └─ Detalj
     ├─ Header (title + badges + meta)
     ├─ Body (markdown-safe)
     ├─ Attachments
     ├─ Actions (ack, reply)
     └─ Thread (messages)

(Upravnik)
 └─ Wizard
     ├─ Korak 1: Sadržaj
     ├─ Korak 2: Meta/Ciljanje
     ├─ Korak 3: Dodatno
     └─ Korak 4: Pregled & Objavi
```

---

## 4. Model podataka (frontend view-model)

### 4.1 Enumi

```dart
enum NoticeStatus { draft, scheduled, published, archived, retracted }
enum NoticePriority { normal, urgent }
enum NoticeScope { building, entrance, floor, group, individual }
enum Channel { inApp, push, email, sms }
enum ThreadAuthorRole { tenant, manager }
```

### 4.2 View modeli

```dart
class NoticeCardVM {
  final String id;
  final String title;
  final String previewText; // 1-2 reda
  final NoticeStatus status;
  final NoticePriority priority;
  final DateTime effectiveAt; // scheduleAt/publishedAt/archivedAt
  final bool isPinned; // premium
  final bool isUnread; // per-user
  final bool requiresAck;
  final bool acked;
  final bool hasNewThreadMessages; // posebno bitno upravniku
  final String scopeLabel; // npr. "Ulaz A" / "Zgrada" / "Sprat 2"
  final List<Channel> channels;
}

class NoticeDetailVM {
  final String id;
  final String title;
  final String bodyMd;
  final NoticeStatus status;
  final NoticePriority priority;
  final DateTime createdAt;
  final DateTime? scheduledAt;
  final DateTime? publishedAt;
  final String authorLabel; // upravnik ime/alias
  final TargetingVM targeting;
  final List<AttachmentVM> attachments;
  final AckVM ack;
  final ThreadVM thread;
  final AuditVM? audit; // upravnik (premium duže)
}

class ThreadVM {
  final int totalCount;
  final List<ThreadMessageVM> items;
  final bool canReply;
  final bool isLocked; // npr. arhivirano + zaključano
  final int unreadCountForManager; // agregat
}

class ThreadMessageVM {
  final String id;
  final ThreadAuthorRole role;
  final String authorLabel; // stan: "B-204" (+ ime ako postoji)
  final String text;
  final List<AttachmentVM> attachments;
  final DateTime createdAt;
  final bool failedToSend; // offline queue
}

class AttachmentVM {
  final String id;
  final String name;
  final String mime;
  final int sizeBytes;
  final Uri url;
  final Uri? thumbUrl;
}

class TargetingVM {
  final NoticeScope scope;
  final String buildingId;
  final List<String>? entrances;
  final List<int>? floors;
  final List<String>? groupIds;
  final List<String>? userIds;
}

class AckVM {
  final bool enabled;
  final bool acked;
  final DateTime? ackedAt;
}
```

---

## 5. Feature flags: Freemium/Premium

### 5.1 Runtime entitlements

Frontend mora imati centralni objekat:

* **Feature flags** (*feature flags*): `features.notifications.*`

Primjeri:

```json
{
  "features": {
    "notifications": {
      "smsChannel": false,
      "failover": false,
      "recurrence": false,
      "automationRules": false,
      "analyticsAdvanced": false,
      "pinning": false,
      "inlinePdfPreview": true
    }
  }
}
```

### 5.2 UI switch Freemium/Premium (prototip + demo)

U Figma i internom QA build-u treba imati **switch**: **Freemium | Premium**.

* U produkciji switch se ne prikazuje korisniku osim ako je “preview mode”.
* Switch samo simulira `features.*` (ne mijenja realnu licencu).

UI pravilo:

* Premium polja su skrivena kada `features.*=false`.
* Ako korisnik dođe deep-linkom do premium ekrana/akcije → pokaži **Info box** (*info callout*) “Dostupno u Premium”.

---

## 6. Globalni UI standardi (tokeni, tipografija, layout)

### 6.1 Tokeni

Koristi `design-tokens.tokens.json` za:

* boje (primary, neutral, success, warning, error)
* spacing (8pt grid)
* radius (12/16)
* focus ring

Mapiranje (minimalno):

* **Button.Primary** (*primary button*): `blue.600` + hover `blue.700`, focus ring `blue.300`, radius `12`
* **Card** (*card*): bg `gray.50`, border `gray.200`, radius `16`
* **Badge** (*badge*): tints `100/200`, text `700`

### 6.2 Tipografija i skaliranje

* Podržati OS scaling: `MediaQuery.textScaleFactor`.
* Ne koristiti fiksne piksele; koristiti `TextTheme` + `em`/`sp` ekvivalente.
* Minimum body: 15–16sp mobile, 16px web.

### 6.3 Layout standard

* Mobile: one-action-per-screen, bottom sheet za quick reply, sticky CTA.
* Web: master-detail gdje ima smisla (upravnik), sidebar filter drawer, tabelarni bulk bar.

---

## 7. Zajedničke komponente (UI kit)

> [!IMPORTANT]
> Sve komponente moraju imati: **disabled**, **loading**, **error**, **focus**, **semantic labels**.

### 7.1 Komponente liste

* **NoticeCard** (*notice card*)

  * Props: `NoticeCardVM`
  * Interakcije:

    * tap → open detail
    * long press (mobile) / checkbox (web manager) → bulk select

* **FilterBar** (*filter bar*)

  * Search input + filter button + sort indicator
  * Mobile: filter overlay (bottom sheet)
  * Web: filter drawer (right panel)

* **BulkActionBar** (*bulk action bar*) — upravnik

  * visible kada `selectedCount>0`
  * actions: archive, retract, export, mark read (notices), change status (ograničeno)

### 7.2 Komponente detalja

* **NoticeHeader** (*notice header*)

  * title + badges (status, priority, scope)
  * meta: author, time, channels

* **AttachmentList** (*attachments*)

  * grid/list, show type icon, file size
  * actions: preview/download

* **AckButton** (*acknowledge button*)

  * states: enabled/disabled, loading, done

* **ReplyCTA** (*reply button*)

  * tenant: “Odgovori upravniku”
  * manager: “Odgovori stanaru” (u grupi)

### 7.3 Komponente thread-a

* **ThreadList** (*thread list*)

  * paginacija, sticky “new messages” marker

* **MessageBubble** (*message bubble*)

  * role-based styling (ne boja-only; koristi oblik + label)

* **ReplyComposer** (*composer*)

  * TextField + attachments + send
  * Mobile: bottom sheet
  * Web: side panel

### 7.4 Komponente wizard-a

* **Stepper** (*stepper*)
* **LivePreviewPanel** (*live preview*)
* **PlanSwitch** (*freemium/premium switch*)

---

## 8. Ekrani — Stanar (mobilni + web)

### 8.1 Ekran: Lista obavještenja (Stanar)

**Route**: `/notices`

#### UI struktura

* AppBar: naslov “Obavještenja”
* Search input (debounce 250ms)
* Filter button (ikon + label)
* Optional chips row: aktivni filteri
* ListView:

  * skeleton loader
  * grouped by date (opciono)
  * NoticeCard items
* Empty state:

  * poruka + CTA “Osvježi”

#### Funkcije

* Pull-to-refresh (mobile)
* Infinite scroll (page size 20)
* Tap card → detail

#### Stanja

* `LoadingInitial`
* `LoadingMore`
* `Empty`
* `Error` (retry)

#### Freemium/Premium

* nema razlike u osnovnom feedu
* premium opcije mogu uključiti: “Važno” (*Important*) i napredne filtere

---

### 8.2 Ekran: Filter overlay (Stanar)

**UI**: bottom sheet (mobile) / drawer (web)

Filteri (freemium):

* Status: Nepročitano/Pročitano
* Tip: Hitno/Normalno
* Period: Danas/7 dana/30 dana/custom

Filteri (premium):

* Kanali (push/email)
* Tagovi
* Ciljanje (ako stanar ima više jedinica)

Akcije:

* Apply
* Reset

---

### 8.3 Ekran: Detalj obavještenja (Stanar)

**Route**: `/notices/:id`

#### UI struktura

* Header (title + badges)
* Body render: markdown-safe
* Attachments
* Actions row:

  * **Potvrdi prijem** (*Acknowledge*) (ako enabled)
  * **Odgovori upravniku** (*Reply*)
* Thread preview (posljednje 3 poruke) + “Prikaži sve”

#### Funkcije

* Automatski mark-as-read kada:

  * ekran u fokusu ≥ 800ms i body skrolovan bar 20% (anti-ghost)
* Ack: optimistički UI + rollback na error
* Reply: otvara composer

#### Freemium/Premium

* Ack i reply su freemium.
* Inline PDF preview može biti premium.

---

### 8.4 Ekran: Reply composer (Stanar)

**UI**: bottom sheet (mobile) / side panel (web)

Polja:

* TextField (max 1000 znakova)
* Attachments (freemium: max 2 slike + 1 PDF; premium: 3 slike + 2 PDF)
* Send button

Validacije:

* prazno → disable send
* rate limit: 10/min

Stanja:

* Sending
* Sent
* Failed (retry)
* Offline queued

---

## 9. Ekrani — Upravnik (web + mobilni)

### 9.1 Ekran: Lista obavještenja (Upravnik)

**Route**: `/notices`

#### UI struktura (web)

* Top bar: naslov + CTA “Novo obavještenje”
* Search + filter + sort
* Tabs/segmented: Draft | Zakazano | Aktivno | Arhiva
* List (ili table) sa checkbox selection
* BulkActionBar kada ima selekcije

#### Mobilni

* Lista sa long-press selekcijom
* Bulk bar kao bottom bar

#### Freemium/Premium

* Premium dodaje:

  * pinning
  * naprednu analitiku badge-ove
  * automatizacije i rekurencu (u wizard-u)

---

### 9.2 Wizard: Korak 1 — Sadržaj (Upravnik)

**Route**: `/notices/new?step=1`

Polja (freemium):

* Naslov (3–120)
* Tijelo (markdown-safe, max 10.000)
* Prilozi: PDF/IMG (max 5; 20MB freemium, 50MB premium)
* Prioritet: Normalno/Hitno

Premium dodatno:

* Pin (trajanje 24/48h)
* Šablon (template) i snimanje šablona

Interakcije:

* Autosave draft svake 2s nakon promjene (debounce)
* Live preview panel (web)

---

### 9.3 Wizard: Korak 2 — Meta/Ciljanje (Upravnik)

**Route**: `/notices/new?step=2`

Freemium:

* Scope: Zgrada | Ulaz | Sprat | Grupa
* Picker (multi-select)
* “Zahtijevaj potvrdu prijema” (toggle)

Premium:

* Individualno ciljanje (pojedinci)
* Napredno ciljanje: kombinacije segmenata

Validacije:

* mora postojati bar jedan cilj

---

### 9.4 Wizard: Korak 3 — Dodatno (Upravnik)

**Route**: `/notices/new?step=3`

Freemium:

* Zakazivanje: odmah / kasnije (datetime)
* Kanali: In-app uvijek; Push/Email ako postoje dozvole

Premium:

* Rekurencija (npr. sedmično/mjesečno) — `features.recurrence`
* Failover (push→email→sms) — `features.failover`
* SMS kanal — `features.smsChannel`
* Automatizacije (npr. “ako manje od 30% pročitano nakon 24h → resend”) — `features.automationRules`

UI pravilo:

* Ako kanal nije dostupan zbog opt-in: prikaži “Nije dostupno za X% korisnika” (agregat)

---

### 9.5 Wizard: Korak 4 — Pregled i objava (Upravnik)

**Route**: `/notices/new?step=4`

Sadržaj:

* Sažetak: naslov, ciljanje, kanali, vrijeme objave
* Preview (mobile + web toggle)
* “Objavi” / “Zakaži”

Stanja:

* Publishing (blocking)
* Success → redirect detail
* Error → inline error + retry

---

### 9.6 Ekran: Detalj obavještenja (Upravnik)

**Route**: `/notices/:id`

Sekcije:

* Header + status + akcije: Edit, Povuci, Arhiviraj
* Body + prilozi
* Metapodaci: ciljanje, kanali, schedule
* Thread centar:

  * **Agregatni prikaz poruka**: grupisano po stanaru
  * filter: “Nove poruke”, “Bez odgovora”, “Hitno” (premium)

Poruke od više stanara:

* Left: lista stanara (chips) sa badge unread count
* Right: razgovor sa odabranim stanarom
* Globalni indikator: `unreadCountForManager`

Freemium:

* osnovno grupisanje + ručni odgovor

Premium:

* brzi odgovori (templates)
* tagging stanara (npr. “ponavlja se”)
* export thread-a u PDF

---

## 10. Tokovi korisnika (state machine)

### 10.1 Stanar — tokovi

1. **Feed → Detail**

* open feed → load page → apply filters → open detail

2. **Mark as read**

* open detail → auto mark read → update local cache

3. **Ack**

* tap ack → optimistic UI → server confirm → snackbar

4. **Reply**

* open composer → type → attach → send
* offline: queue → send later

5. **Deep link**

* push tap → open detail → focus thread → scroll to messageId

### 10.2 Upravnik — tokovi

1. **Create draft**

* open wizard → fill step1 → autosave draft

2. **Targeting**

* choose scope → validate → next

3. **Schedule**

* now/later → validate timezone

4. **Publish**

* review → publish → success → detail

5. **Edit**

* open detail → edit → save → audit update

6. **Retract**

* retract published → confirm modal → status retracted

7. **Archive**

* archive notice → remove from active lists

8. **Thread multi-resident**

* incoming messages → badge increments → manager replies per resident

---

## 11. Filteri, pretraga i sortiranje

### 11.1 Sort pravila (kanonsko)

Uključiti algoritam iz specifikacije:

* Stanar slojevi: pin urgent > urgent > important(premium) > unread > read > archive
* Upravnik status slojevi: draft > scheduled(ASC) > active(DESC) > retracted > archived

### 11.2 Pretraga

* Lokalni filter na već učitane + server search kada `query.length>=2`
* debounce 250ms
* highlight match u title/preview

### 11.3 Filter persistence

* sačuvati poslednje filtere po ulozi u local storage

---

## 12. Thread poruke: stanar ↔ upravnik

### 12.1 Pravila poruka

* Poruke su vezane za `noticeId`.
* Stanar može slati poruke bez email/telefona.
* Upravnik vidi poruke od više stanara, grupisano.

### 12.2 Prikaz identiteta stanara

* Primarno: `unitLabel` (npr. “B-204”)
* Ime samo ako postoji i dozvoljeno.
* Bez telefona/emaila u UI.

### 12.3 Brisanje poruka

* Nema bulk brisanja.
* Pojedinačno brisanje (samo upravnik) = **soft delete** + audit.

---

## 13. Bulk akcije (upravnik)

Bulk je nad **obavještenjima**, ne nad porukama.

Akcije (freemium):

* Arhiviraj
* Povuci (ako dozvoljeno)
* Export (CSV/PDF lista)

Premium:

* Export sa analitikom (open/ack)
* Masovno pinovanje (ako policy dozvoljava)

UI:

* Selection checkboxes (web)
* Long-press selection (mobile)

---

## 14. Notifikacije (push/email/in-app)

### 14.1 In-app

* Badge na tabu modula: broj nepročitanih
* Unutar kartica: `isUnread`

### 14.2 Push

* payload: `noticeId`, opc. `messageId`, `focus=thread`
* tap → deep link

### 14.3 Email

* opt-in; ako nema emaila ne šalje se
* UI prikazuje agregat dostupnosti kanala

### 14.4 SMS (premium)

* samo ako `features.smsChannel=true` i korisnik opt-in

---

## 15. Offline, keš, sinhronizacija

### 15.1 Keš strategija

* Keširati:

  * posljednje 20 kartica (freemium) / 50 (premium)
  * detalj zadnje 10 posjećenih

### 15.2 Offline akcije

* Stanar reply: queue + retry
* Ack: queue (opciono) ili blokirati uz poruku “Povežite se”

### 15.3 Konflikti

* Ako se obavještenje povuče/arhivira dok je korisnik u detail:

  * prikazati banner “Status promijenjen” + refresh

---

## 16. Greške, izuzeci i edge cases

* 403 (nema prava) → ekran “Nemate pristup”
* 404 (obavještenje ne postoji) → fallback u listu
* Upload fail → retry per fajl
* Rate limit poruka → inline error “Previše poruka, pokušajte kasnije”
* Zakazivanje u prošlosti (timezone) → blokirati

---

## 17. Pristupačnost (WCAG 2.1 AA) — checklista

* Kontrast ≥ 4.5:1
* Tap target ≥ 44px
* Fokus outline 2px (token)
* Tastatura (web): Tab/Shift+Tab, Enter submit, Esc close
* Screen reader: semantics label za badge-e, dugmad, status
* Ne oslanjati se samo na boju (status ima i tekst)
* Podržati text scaling

---

## 18. Analitika događaja (event schema)

Eventi (minimalno):

* `notice_list_view`
* `notice_open`
* `notice_filter_apply`
* `notice_search`
* `notice_ack`
* `thread_reply_send`

Upravnik:

* `notice_create_start`
* `notice_create_step_complete`
* `notice_publish`
* `notice_schedule`
* `notice_edit`
* `notice_archive`
* `notice_retract`

Dimenzije:

* role, buildingId, scope, channel, plan(free/plus), device

---

## 19. QA/Acceptance kriterijumi (po ekranu)

### 19.1 Lista

* [ ] Skeleton → list render bez skakanja
* [ ] Filter apply/reset radi
* [ ] Sort stabilan (tie-breaker id)
* [ ] Offline: prikazuje keš

### 19.2 Detalj

* [ ] Auto mark read nakon 800ms + 20% scroll
* [ ] Ack optimistic UI + rollback
* [ ] Attachment preview/download radi

### 19.3 Thread

* [ ] Reply send + retry
* [ ] Offline queue radi
* [ ] Upravnik vidi poruke grupisane po stanaru

### 19.4 Wizard

* [ ] Validacije po koraku
* [ ] Autosave draft
* [ ] Premium polja skrivena kada flag=false

---

## 20. Implementacioni koraci (Sprint-ready)

1. Postavi rute + role-aware guard
2. Implementiraj Notice list (VM + repo)
3. Filter overlay + persistence
4. Detail screen + attachments
5. Thread (tenant) + composer + offline queue
6. Thread (manager) grupisanje po stanaru
7. Wizard 4 koraka + autosave + preview
8. Bulk selection + actions
9. Notifikacije deep link handler
10. A11y pass + analytics hooks

— Kraj dokumenta —
