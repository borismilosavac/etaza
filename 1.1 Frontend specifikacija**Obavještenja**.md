# Zgrada Plus — Modul **Obavještenja** (*Notifications*) — AI Frontend Blueprint (Flutter) — GitHub MD v2.0

> [!IMPORTANT]
> Ovaj dokument je napisan da AI model za dizajn/implementaciju razumije **svaki detalj** bez dodatnog konteksta. Pokriva **sve ekrane**, **sve UI elemente**, **sva stanja**, **sve tokove**, **Freemium/Premium** separaciju, te konkretne smjernice za Flutter (**Mobilna** *Mobile* + **Web** *Web*).

---

## 0) Pravila čitanja dokumenta (za AI)

1. Sve što je označeno kao **Obavezno** (*Required*) mora postojati u Freemium, osim ako je eksplicitno označeno kao Premium-only.
2. Sve interakcije su determinističke: svaki klik/tap ima jasno definisan rezultat, navigaciju, validaciju i povratnu poruku.
3. Telefon i email su opcioni. Nema hard dependency na te podatke.
4. **Upravnik** (*Manager*) ima punu funkcionalnost na webu; mobilna verzija upravnika je funkcionalno podskup.
5. UI mora biti **WCAG 2.1 AA** (kontrast, fokus, tastatura, screen reader, font scaling).

---

## 1) Scope modula

### 1.1 Šta modul radi

* **Upravnik** (*Manager*) kreira, zakazuje, objavljuje, cilja, arhivira/povlači obavještenja; prima i obrađuje poruke stanara vezane za obavještenje.
* **Stanar** (*Resident*) pregledava feed, filtrira, čita detalje, preuzima priloge, potvrđuje prijem i odgovara upravniku kroz privatni thread.

### 1.2 Šta modul NE radi

* Ne služi kao opšti chat za zgradu. Komunikacija je vezana za konkretno obavještenje (thread per obavještenje).
* Ne zavisi od email/telefona kao obaveznog kanala.

---

## 2) Uloge, prava i planovi

### 2.1 Uloge

* **Stanar** (*Resident*)
* **Upravnik** (*Manager*)

### 2.2 Planovi

* **Freemium** (*Freemium*) — pokriva normalan rad zgrade.
* **Premium** (*Premium*) — dodaje automatizacije, naprednu analitiku, SMS fallback, rekurentno zakazivanje, napredne eksport funkcije.

### 2.3 Entitlements i toggling (za prototip)

* U dev/prototip buildu postoji **Prekidač plana** (*Plan toggle*): `Freemium ⟷ Premium`.
* U produkciji plan dolazi sa servera (`entitlements.plan`). Prekidač nije vidljiv.
* Premium UI se prikazuje kao:

  * `hidden` (ako pravilo kaže “ne prikazivati”), ili
  * `disabled + badge Premium` (ako treba da bude vidljiv ali nedostupan).

---

## 3) Domenski model (data contract)

### 3.1 Entitet: **Obavještenje** (*Notice*)

Minimalni atributi:

* `id: string`
* `title: string`
* `bodyMd: string` (Markdown)
* `attachments: Attachment[]`
* `priority: normal | urgent`
* `pinUntil: DateTime?`
* `requiresAck: bool`
* `status: draft | scheduled | published | retracted | archived`
* `targeting: Targeting` (building/entrance/floor/group/unit)
* `channels: { inApp: true, push: bool, email: bool, sms: bool }`
* `createdAt, updatedAt, publishedAt?, scheduleAt?, archivedAt?, retractedAt?`

### 3.2 Entitet: **Poruka** (*Message*)

* `id`
* `noticeId`
* `threadId` (per stanar per obavještenje)
* `fromRole: resident | manager`
* `fromId`
* `unitLabel` (npr. “B-204”, prikaz bez PII)
* `text`
* `attachments: Attachment[]`
* `createdAt`
* `readByManagerAt?`, `readByResidentAt?`

### 3.3 Entitet: **Read/Ack**

* **Pročitano** (*Read*): `readAt` per user per notice
* **Potvrđeno** (*Acknowledged*): `ackAt` per user per notice

### 3.4 Entitet: **Attachment**

* `id, name, mime, sizeBytes, url`
* `type: image | pdf | other`
* `thumbUrl?`

### 3.5 Targeting

* `buildingId (required)`
* `entranceIds[]?`
* `floors[]?`
* `groupIds[]?`
* `unitIds[]?`

---

## 4) Navigacija, rute i deep linkovi

### 4.1 Stanar rute

* `/notifications` — lista
* `/notifications/:id` — detalj

### 4.2 Upravnik rute

* `/notifications` — upravljačka lista
* `/notifications/new` — wizard
* `/notifications/:id` — detalj + poruke stanara
* `/notifications/:id/edit` — edit draft/scheduled

### 4.3 Deep link pravila

* Otvaranje `/notifications/:id` uvijek:

  * učita obavještenje,
  * provjeri pristup (u targetingu),
  * ako nema pristup → ekran **Nedostupno** (*Not available*).
* Ako ima pristup → ekran detalja; nakon `2s` ili `60% scroll` set **Pročitano**.

---

## 5) Globalne UI konvencije

### 5.1 Layout

* **Mobilna** (*Mobile*): jedna kolona, sticky bottom actions.
* **Web** (*Web*): 2–3 kolone po potrebi:

  * lista + detalj (master-detail),
  * sidebar za filtere/stats.

### 5.2 Standardne komponente

* **Kartica obavještenja** (*Notice card*)
* **Filter overlay/panel** (*Filter overlay/panel*)
* **Pretraga** (*Search*)
* **Badge** (*Badge*) i **Chip** (*Chip*)
* **Bottom sheet composer** (*Composer*)
* **Dialog potvrde** (*Confirm dialog*)
* **Toast/Snackbar** (*Snackbar*)
* **Skeleton loader** (*Skeleton*)

### 5.3 Standardne poruke

* Snackbar uspjeha: kratka, jedna rečenica.
* Error: prikazati “razlog + akcija” (npr. “Greška u mreži · Pokušaj ponovo”).

---

## 6) Sortiranje i grupisanje (deterministički)

### 6.1 Stanar default sort (feed)

Slojevi (od vrha):

1. **Pinovana hitna** (*Pinned urgent*)
2. **Hitna** (*Urgent*)
3. **Važna** (*Important*, Premium — user mark)
4. **Nepročitana** (*Unread*)
5. **Pročitana** (*Read*)
6. **Arhiva** (*Archived*) — samo uz filter

Datum:

* `scheduled → scheduleAt`
* `published → publishedAt`
* `archived → archivedAt (fallback publishedAt)`

Smjer: `DESC` (novije gore). Tie-breaker: `id DESC`.

### 6.2 Upravnik default sort

Status slojevi:

1. **Nacrt** (*Draft*) — `updatedAt DESC`
2. **Zakazano** (*Scheduled*) — `scheduleAt ASC`
3. **Objavljeno** (*Published*) — `publishedAt DESC`
4. **Povučeno** (*Retracted*) — `retractedAt DESC`
5. **Arhiva** (*Archived*) — `archivedAt DESC`

Boost unutar istog statusa:

* `hasNewResidentMessages=true` ide gore, ali ne prelazi status sloj.

---

## 7) STANAR — Ekran 1: Lista obavještenja

### 7.1 Frame specifikacija (Mobile)

**AppBar**:

* Title: **Obavještenja** (*Notifications*)
* Actions:

  * **Pretraga** (*Search icon*)
  * **Filter** (*Filter icon*)

**Body**:

* `ListView` kartica
* Sticky top: optional “Pinned section” (ako postoje pinovane)

**Bottom**:

* (Optional) badge counter “Nepročitano: N” (ne blokira UI)

### 7.2 Frame specifikacija (Web)

* Header: title + search input + filter button
* Left: filter panel (collapsible)
* Center: list

### 7.3 Komponenta: **NoticeCard** (*Notice card*)

**Elementi**:

* Title (max 2 linije)
* Meta line: datum + targeting summary (npr. “Ulaz A”)
* Badges (0–4):

  * **Novo** (*New*) = unread
  * **Hitno** (*Urgent*)
  * **Potvrda** (*Ack required*) = requiresAck && !ack
  * **Pin** (*Pinned*) = pinUntil > now

**Interakcije**:

* Tap/click → otvori detalj (`/notifications/:id`)
* Long-press (mobile) / right-click (web) → contextual menu:

  * **Označi pročitano/nepročitano** (*Mark read/unread*)
  * **Arhiviraj** (*Archive*)

### 7.4 Filter UI

**Filter overlay** (*Mobile overlay*) / **Filter panel** (*Web panel*)

* Chips:

  * **Sve** (*All*)
  * **Nepročitano** (*Unread*)
  * **Hitno** (*Urgent*)
  * **Potvrda** (*Ack required*)
* Period:

  * 7 / 30 / 90 dana
* Segment (ako je dostupno): ulaz/sprat
* Buttons:

  * **Primijeni** (*Apply*)
  * **Resetuj** (*Reset*)

### 7.5 Pretraga

* Search input (web) ili search screen (mobile)
* Debounce 300ms
* Pretraga po `title` i `bodyMd` (Premium: i po attachment OCR, ako postoji)

### 7.6 Stanja

* Loading: skeleton 8 kartica
* Empty: tekst “Nema obavještenja” + dugme **Osvježi** (*Refresh*)
* Error: inline banner + retry
* Offline: prikaz keša + label “Offline”

### 7.7 Freemium/Premium razlike (Stanar lista)

* **Freemium**: svi filteri osim “Važna”
* **Premium**: mogućnost označavanja **Važno** (*Important*) i filter “Važna”

---

## 8) STANAR — Ekran 2: Detalj obavještenja

### 8.1 Layout (Mobile)

* AppBar: back + overflow
* Body:

  * Title
  * Meta: datum + badges
  * Markdown body
  * Attachments
  * Thread preview (zadnjih N)
* Sticky bottom actions:

  * Primary: **Odgovori upravniku** (*Reply to manager*)
  * Secondary: **Potvrdi prijem** (*Acknowledge*) (samo ako requiresAck && !ack)

### 8.2 Pravila “Pročitano”

Obavještenje se označava kao **Pročitano** (*Read*) kada:

* korisnik provede ≥ 2 sekunde na ekranu, ili
* skrol do ≥ 60% sadržaja.

### 8.3 Attachments

* Image: inline preview + full screen viewer
* PDF:

  * Freemium: tile + **Preuzmi** (*Download*)
  * Premium: tile + **Pregledaj** (*Inline preview*) + download
* Error download: toast + retry

### 8.4 Overflow menu (Stanar)

* **Podijeli** (*Share*) — samo ako policy dozvoljava
* **Prijavi problem** (*Report issue*) — log event, ne otvara novi modul u v1

### 8.5 Thread preview (read-only list)

* Sort `ASC` (starije gore)
* Prikaz:

  * bubble style
  * label pošiljaoca: “Upravnik” ili `unitLabel`

---

## 9) STANAR — Bottom Sheet: “Odgovori upravniku”

### 9.1 Otvaranje

Tap na **Odgovori upravniku** otvara **Bottom sheet composer** (*Composer*).

### 9.2 UI elementi

* Header: “Poruka upravniku”
* Text area (multiline)
* Attachment row:

  * add image
  * add PDF
* CTA: **Pošalji** (*Send*)

### 9.3 Validacije

* Tekst 1–1000 znakova OR minimum 1 prilog
* Attachments limiti:

  * Freemium: 2 slike + 1 PDF, max 10MB po fajlu
  * Premium: 4 slike + 2 PDF, max 20MB po fajlu

### 9.4 State mašina slanja

* `idle → validating → sending → success|fail`
* Sending: disable CTA + progress
* Success: close sheet + snackbar “Poruka poslata”
* Fail: inline error + retry

### 9.5 Offline queue

Ako offline:

* poruka ide u queue (`pending`)
* UI prikazuje status “Čeka slanje”
* automatski retry na reconnect

---

## 10) UPRAVNIK — Ekran 1: Lista obavještenja (Web primarno)

### 10.1 Layout (Web)

* Header:

  * Title: **Obavještenja** (*Notifications*)
  * CTA: **Novo obavještenje** (*New notice*)
* Left: filter panel (sticky)
* Center: list
* Right: optional stats panel (Premium)

### 10.2 Filter panel (upravnik)

* Status multi-select: draft/scheduled/published/retracted/archived
* Prioritet: normal/hitno
* Segment: building/entrance/floor
* Period: created/published range
* Toggle: **Ima nove poruke** (*Has new messages*)

### 10.3 Bulk mode

* Checkbox per card
* Bulk actions:

  * **Arhiviraj** (*Archive*)
  * **Povuci** (*Retract*) (samo published)
  * **Export** (*Export*)

**Pravila**:

* Bulk brisanje poruka: **nije dozvoljeno**.
* Bulk brisanje obavještenja: **nije dozvoljeno** u v1 (samo arhiva).

### 10.4 Upravnik kartica

* Title
* Status badge
* Target summary
* Published/schedule meta
* `newMessagesCount` badge

### 10.5 Stanja

* Loading skeleton
* Empty: “Još nema obavještenja” + CTA
* Error: banner + retry

---

## 11) UPRAVNIK — Ekran 2: Wizard kreiranja (4 koraka)

> [!NOTE]
> Wizard je identičan na webu i mobilnoj upravnik verziji, ali na mobilnoj je pojednostavljen UI (manje panela).

### 11.1 Korak 1 — **Sadržaj** (*Content*)

UI:

* Field: **Naslov** (*Title*)
* Field: **Sadržaj** (*Body*) — markdown editor
* Attachments uploader

Validacije:

* Title: 3–120
* Body: ≥10
* Attachments:

  * Freemium: max 3 fajla, max 20MB po fajlu
  * Premium: max 5 fajlova, max 50MB po fajlu

CTA:

* **Dalje** (*Next*) disabled dok invalid

### 11.2 Korak 2 — **Ciljanje** (*Targeting*)

UI:

* Select: **Zgrada** (*Building*) — required
* Multi-select: **Ulaz** (*Entrance*)
* Optional: **Sprat** (*Floor*)
* Optional: **Grupa** (*Group*)
* Summary chip: “Ciljano: N stanova”

Validacija:

* minimum 1 targeting path (building always required)

### 11.3 Korak 3 — **Dodatno** (*Extras*)

UI toggles:

* **Hitno** (*Urgent*)
* **Pinuj** (*Pin*) + trajanje 24h/48h
* **Traži potvrdu** (*Requires acknowledge*)
* **Zakazivanje** (*Schedule*)

  * Freemium: jednokratno
  * Premium: jednokratno + rekurentno
* **Kanali** (*Channels*)

  * In-app: always on
  * Push toggle
  * Email toggle
  * SMS toggle (Premium)

Informativni chip:

* “Telefon/email opcioni; in-app je primarni kanal.”

### 11.4 Korak 4 — **Pregled i objava** (*Review & publish*)

UI:

* Preview card (mobile + web)
* Summary: targeting, schedule, channels
* CTA:

  * **Objavi** (*Publish*)
  * **Zakaži** (*Schedule*) (ako scheduleAt)
  * **Sačuvaj nacrt** (*Save draft*)

State:

* submitting: loader
* fail: inline error
* success: route to detail + snackbar

### 11.5 Autosave (upravnik)

* Draft autosave:

  * na prelazu koraka
  * i svakih 10 sekundi idle
* Snackbar: “Sačuvano kao nacrt”

---

## 12) UPRAVNIK — Ekran 3: Detalj obavještenja + poruke stanara

### 12.1 Layout (Web: master-detail)

* Top header: title + status + actions
* Left/center: obavještenje content + attachments
* Right: panel “Poruke stanara”

### 12.2 Panel “Poruke stanara” (više stanara)

Prikaz listom “konverzacija po stanu”:

* Row:

  * `unitLabel`
  * last message snippet
  * timestamp
  * unread badge

Filteri:

* **Bez odgovora** (*Unreplied*)
* **Nepročitano** (*Unread*)
* **Sve** (*All*)

Klik na row otvara:

* Web: desni sub-panel conversation
* Mobile: full screen conversation page

### 12.3 Conversation view (upravnik)

* Message list (ASC)
* Composer:

  * text input
  * 1 image/PDF attachment (limit)
  * CTA **Pošalji**

State:

* sending/sent/fail

### 12.4 Akcije na obavještenju (upravnik)

* **Uredi** (*Edit*)

  * dozvoljeno: `draft`
  * dozvoljeno: `scheduled` samo do `scheduleAt - 2min`
  * nedozvoljeno: `published`
* **Povuci** (*Retract*) — samo `published`
* **Arhiviraj** (*Archive*) — `published` ili `retracted`
* **Napravi novu verziju** (*Create new version*) — Premium

---

## 13) Notifikacije (push/email/SMS) — logika bez email/telefona

### 13.1 Kanali i fallback

* **In-app** (*In-app*) je uvijek primarni.
* **Push** (*Push*) samo ako postoji push token.
* **Email** (*Email*) samo ako postoji email.
* **SMS** (*SMS*) samo Premium i samo ako postoji broj.

### 13.2 Stanar dobija

* Novo obavještenje: in-app + push (ako token) + email (ako postoji) + sms (premium)
* Odgovor upravnika: in-app + push/email/sms po istim pravilima

### 13.3 Upravnik dobija

* Nova poruka stanara: web badge + push (ako token) + email digest (Premium)

---

## 14) Freemium vs Premium — precizna separacija

### 14.1 Stanar

**Freemium (obavezno):**

* lista + filteri
* detalj + download priloga
* odgovor upravniku
* potvrda prijema
* push ako token postoji
* offline cache 10

**Premium (dodatno):**

* SMS obavještenja (ako broj postoji)
* inline PDF preview
* veći limiti priloga u poruci
* označi **Važno** (*Important*) + filter
* arhiva 12 mjeseci + lični export
* offline cache 20

### 14.2 Upravnik

**Freemium (obavezno):**

* kreiranje/objava
* jednokratno zakazivanje
* ciljanje segmenata
* poruke stanara (više stanara)
* osnovni export CSV

**Premium (dodatno):**

* rekurentno zakazivanje
* automatizacije podsjetnika
* SMS fallback
* napredna analitika (views/ack)
* kanban view
* verzionisanje obavještenja
* export PDF + napredni CSV

---

## 15) State mašine (global)

### 15.1 Feed

`idle → loading → ready → refreshing → error`

### 15.2 Detail

`loading → ready → (markReadPending) → ready → (sendingMessage) → ready | error`

### 15.3 Wizard

`step1 → step2 → step3 → step4 → submitting → success|fail`

---

## 16) Validacije, greške, snackbars

### 16.1 Validacije

* Title 3–120
* Body ≥10
* Message: tekst ≥1 ili ≥1 prilog
* ScheduleAt: now + 2min minimum
* Attachment types:

  * notice attachments: `jpg/png/pdf`
  * message attachments: `jpg/png/pdf/mp4` (ako dozvoljeno)

### 16.2 Standardni error kodovi

* `VAL_TITLE_TOO_SHORT`
* `VAL_BODY_TOO_SHORT`
* `VAL_MESSAGE_EMPTY`
* `VAL_SCHEDULE_IN_PAST`
* `UPLOAD_TOO_LARGE`
* `UPLOAD_TYPE_NOT_ALLOWED`
* `NETWORK_OFFLINE`

### 16.3 Snackbars (standard)

* “Sačuvano kao nacrt”
* “Obavještenje objavljeno”
* “Obavještenje zakazano”
* “Poruka poslata”
* “Potvrda evidentirana”

---

## 17) Pristupačnost

* Kontrast ≥ 4.5:1
* Tap target ≥ 44px
* Fokus ring 2px
* Screen reader labels za badgeve: Novo/Hitno/Potvrda/Pin
* Font scaling bez overflow-a
* Web tastatura:

  * `Ctrl+K` fokus na pretragu
  * `Esc` zatvara overlay/bottom sheet
  * `Ctrl+Enter` šalje poruku (ako validno)

---

## 18) Flutter implementacija (konkretno)

### 18.1 Folder struktura

`features/notifications/{data,domain,presentation}`

### 18.2 Pages

* `ResidentNotificationsListPage`
* `ResidentNotificationDetailPage`
* `ResidentReplyBottomSheet`
* `ManagerNotificationsListPage`
* `NoticeWizardPage`
* `ManagerNoticeDetailPage`

### 18.3 Widgets

* `NoticeCard`
* `NoticeBadges`
* `NoticeFilterOverlay`
* `NoticeSearchField`
* `MarkdownBody`
* `AttachmentGrid`
* `ThreadConversationsList`
* `ConversationView`
* `MessageComposer`

### 18.4 Controllers (state)

* `NotificationsFeedController`
* `NoticeDetailController`
* `NoticeWizardController`
* `ManagerNoticeDetailController`

### 18.5 Offline

* Cache 10/20 notices
* Queue pending messages
* Merge strategy: stable sort + id tie-breaker

---

## 19) Analitika

Eventi:

* `notice_list_view`
* `notice_filter_apply`
* `notice_search`
* `notice_open`
* `notice_ack`
* `notice_message_send`
* `notice_create_draft`
* `notice_publish`
* `notice_schedule`
* `notice_retract`
* `notice_archive`

Dimenzije:

* `role`, `plan`, `channel`, `segment`, `platform`, `locale`

---

## 20) QA acceptance (minimalni set)

### 20.1 Stanar

* Lista: učitavanje, filter, pretraga
* Detalj: read marking, attachments download
* Reply: slanje poruke, retry, offline queue
* Ack: potvrda i update list badge

### 20.2 Upravnik

* Wizard: draft autosave, publish, schedule
* Detalj: poruke više stanara, odgovori, unread badges
* Bulk: arhiva, retract, export
* Premium: rekurentno schedule + analytics + sms fallback

— Kraj dokumenta —
